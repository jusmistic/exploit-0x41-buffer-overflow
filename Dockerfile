FROM ubuntu:14.04
ENV DEBIAN_FRONTEND noninteractive

RUN dpkg --add-architecture i386
RUN apt-get update && \
	apt-get install -y openssh-server git python build-essential gdb wget python-pip python-dev git libssl-dev libffi-dev vim libc6:i386 

WORKDIR /tmp

#Radare2 Install
RUN git clone https://github.com/radare/radare2.git && \
	cd radare2 && \
	sys/install.sh

#useradd
RUN useradd -ms /bin/bash user
RUN echo 'user:user' | chpasswd
USER user

#gef install
RUN wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh

#pwntools install
#USER user
RUN python -m pip install --upgrade pip --user
RUN python -m pip install --upgrade pwntools --user
USER root
#Workshop
RUN mkdir /home/user/workshop
WORKDIR /home/user/workshop

#add Basic BOF
RUN useradd basic-bof
COPY src/basic-bof basic-bof
RUN chown -R user:user /home/user/workshop/*
RUN echo "Sec-D{B@s1c_BOF}" > basic-bof/flag.txt
RUN chown basic-bof:basic-bof basic-bof/flag.txt
RUN chmod 400 basic-bof/flag.txt
RUN chmod a+x basic-bof/greet
RUN chown basic-bof:basic-bof basic-bof/greet
RUN chmod u+s basic-bof/greet

#add ret2libc
RUN useradd ret2libc
COPY src/ret2libc/ ret2libc
RUN chown -R user:user /home/user/workshop/ret2libc/*
RUN chown -R user:user /home/user/workshop/ret2libc
RUN echo "Sec-D{Ret2L1bC_eiei}" > ret2libc/flag.txt
RUN chown ret2libc:ret2libc ret2libc/flag.txt
RUN chmod 400 ret2libc/flag.txt
RUN chmod a+x ret2libc/greet2
RUN chown ret2libc:ret2libc ret2libc/greet2
RUN chmod u+s ret2libc/greet2

#entrypoint
RUN apt-get install -y openssh-server
WORKDIR /tmp
COPY start.sh start.sh
RUN chmod a+x start.sh
CMD echo "sshd: ALL"  >> /etc/hosts.allow
CMD echo "AllowUsers user" >> /etc/ssh/sshd_config

ENV LC_CTYPE C.UTF-8
#Add banner
COPY banner.txt /home/user/.banner
EXPOSE 22
ENTRYPOINT ["./start.sh"]
 
